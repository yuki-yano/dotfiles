---
description: Detect TypeScript code duplication using similarity-ts and create refactoring plan
---

# TypeScriptコードの重複検知とリファクタリング計画: $ARGUMENTS

## 目標

similarity-tsを使用してTypeScriptコードベース内の重複コードを検知し、効率的なリファクタリング計画を作成する

## 手順（順番に実行）

ステップ 1. **similarity-ts のインストール確認**
- `which similarity-ts` で既存インストールを確認
- 未インストールの場合: `cargo install similarity-ts` を実行
- インストール済みの場合: バージョンを確認

ステップ 2. **プロジェクトのTypeScriptファイル確認**
- `.ts`, `.tsx`, `.js`, `.jsx` ファイルの場所を確認
- 除外すべきディレクトリを特定（node_modules, dist, build など）
- ファイル数と総行数を把握

ステップ 3. **similarity-ts の実行**
- プロジェクトルートで `similarity-ts .` を実行
- 出力結果を `ai/tmp/similarity-report.txt` に保存
- エラーが発生した場合は詳細を確認

ステップ 4. **重複コードの分析**
検出された重複について以下を分析:
- 重複度（類似性のパーセンテージ）
- 影響範囲（ファイル数、行数）
- 重複パターンの種類（完全一致、構造的類似など）
- 重複の意図（意図的な重複か、偶発的か）

ステップ 5. **リファクタリング優先度の判定**
以下の基準で優先度を設定:
- 高優先度: 80%以上の類似性、3箇所以上で重複
- 中優先度: 60-79%の類似性、2箇所で重複
- 低優先度: 40-59%の類似性、または小規模な重複

ステップ 6. **リファクタリング計画の作成**
`ai/plans/active/refactor-duplications.md` に以下の形式で保存:
```markdown
# TypeScriptコード重複リファクタリング計画

生成日: <YYYY-MM-DD HH:MM>
分析対象: <ファイル数>ファイル、<総行数>行

## 検出された重複の概要

### 統計情報
- 検出された重複グループ: <数>
- 影響を受けるファイル: <数>
- 削減可能な行数（推定）: <数>

## 高優先度リファクタリング

### 1. <重複パターンの説明>
- 類似度: <パーセンテージ>%
- 影響ファイル:
  - file1.ts:10-50
  - file2.ts:100-140
- 推奨アクション: 共通関数/クラスに抽出
- 実装案:
  ```typescript
  // 共通化後のコード例
  ```

## 中優先度リファクタリング
...

## 低優先度リファクタリング
...

## 実施計画

### フェーズ1: 高影響度の重複解消（1-2日）
- [ ] 共通ユーティリティ関数の作成
- [ ] 重複コードの置き換え
- [ ] テストの更新

### フェーズ2: 構造的改善（3-5日）
- [ ] 共通インターフェースの定義
- [ ] 基底クラスの作成
- [ ] コンポーネントの統合

## 注意事項
- テストカバレッジを維持しながら実施
- 段階的にリファクタリング（一度に大量の変更を避ける）
- 各変更後に動作確認を実施
```

ステップ 7. **TodoListへの反映**
作成したリファクタリング計画から、実行可能なタスクをTodoListに追加